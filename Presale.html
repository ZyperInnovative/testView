<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XYZ Coin Presale</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google reCAPTCHA v2 API -->
    <!-- Site key updated with the one provided by the user -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style>
        /* Base styles from your provided neumorphic design */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s ease;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        /* Light Theme */
        body.light-theme {
            background: #e0e5ec;
            color: #333;
        }
        body.light-theme .container {
            background: #e0e5ec;
            box-shadow: 10px 10px 30px #c2c8d0, -10px -10px 30px #ffffff;
        }
        body.light-theme .header-actions button {
            background: #e0e5ec;
            box-shadow: 6px 6px 10px #c2c8d0, -6px -6px 10px #ffffff;
        }
        body.light-theme .header-actions button:hover {
            background: #d6dce4;
        }
        body.light-theme .tabs button {
            background: #e0e5ec;
            box-shadow: 3px 3px 6px #c2c8d0, -3px -3px 6px #ffffff;
        }
        body.light-theme .tabs button.active {
            background: #d1d9e6;
            box-shadow: inset 2px 2px 5px #bec4cb, inset -2px -2px 5px #f0f5fa;
        }
        body.light-theme input,
        body.light-theme .btn,
        body.light-theme .price-card,
        body.light-theme .wallet-info,
        body.light-theme .dashboard-info-card {
            background: #e0e5ec;
            box-shadow: inset 4px 4px 6px #c8ccd1, inset -4px -4px 6px #f0f5fa; /* Input shadow */
        }
        body.light-theme .btn,
        body.light-theme .price-card,
        body.light-theme .social,
        body.light-theme .dashboard-info-card {
            box-shadow: 6px 6px 10px #c2c8d0, -6px -6px 10px #ffffff; /* Button and card shadow */
        }
        body.light-theme .btn:hover,
        body.light-theme .price-card:hover,
        body.light-theme .social:hover {
            background: #d6dce4;
        }
        body.light-theme .or {
            color: #666;
        }
        body.light-theme .modal-content {
            background-color: #e0e5ec;
            box-shadow: 10px 10px 30px #c2c8d0, -10px -10px 30px #ffffff;
            color: #333;
        }
        body.light-theme .modal-buttons button {
            background-color: #007bff;
            box-shadow: 3px 3px 6px #c2c8d0, -3px -3px 6px #ffffff;
            color: white;
        }
        body.light-theme .modal-buttons button:hover {
            background-color: #0056b3;
            box-shadow: inset 2px 2px 5px #bec4cb, inset -2px -2px 5px #f0f5fa;
        }
        body.light-theme .dashboard-main-card {
            background: #e0e5ec;
            box-shadow: 12px 12px 35px #b0b5bd, -12px -12px 35px #f0f5fa; /* More prominent shadow */
        }
        body.light-theme .dashboard-main-card:hover {
            box-shadow: 15px 15px 40px #a0a5ac, -15px -15px 40px #ffffff; /* Even more prominent on hover */
        }


        /* Dark Theme */
        body.dark-theme {
            background: #2c2f33;
            color: #e0e0e0;
        }
        body.dark-theme .container {
            background: #2c2f33;
            box-shadow: 10px 10px 30px #232528, -10px -10px 30px #35393f;
        }
        body.dark-theme .header-actions button {
            background: #2c2f33;
            box-shadow: 6px 6px 10px #232528, -6px -6px 10px #35393f;
        }
        body.dark-theme .header-actions button:hover {
            background: #36393f;
        }
        body.dark-theme .tabs button {
            background: #2c2f33;
            box-shadow: 3px 3px 6px #232528, -3px -3px 6px #35393f;
        }
        body.dark-theme .tabs button.active {
            background: #36393f;
            box-shadow: inset 2px 2px 5px #2a2d30, inset -2px -2px 5px #42454a;
        }
        body.dark-theme input,
        body.dark-theme .btn,
        body.dark-theme .price-card,
        body.dark-theme .wallet-info,
        body.dark-theme .dashboard-info-card {
            background: #2c2f33;
            box-shadow: inset 4px 4px 6px #24272a, inset -4px -4px 6px #34373d; /* Input shadow */
        }
        body.dark-theme .btn,
        body.dark-theme .price-card,
        body.dark-theme .social,
        body.dark-theme .dashboard-info-card {
            box-shadow: 6px 6px 10px #232528, -6px -6px 10px #35393f; /* Button and card shadow */
        }
        body.dark-theme .btn:hover,
        body.dark-theme .price-card:hover,
        body.dark-theme .social:hover {
            background: #36393f;
        }
        body.dark-theme .or {
            color: #a0a0a0;
        }
        body.dark-theme .modal-content {
            background-color: #2c2f33;
            box-shadow: 10px 10px 30px #232528, -10px -10px 30px #35393f;
            color: #e0e0e0;
        }
        body.dark-theme .modal-buttons button {
            background-color: #007bff;
            box-shadow: 3px 3px 6px #232528, -3px -3px 6px #35393f;
            color: white;
        }
        body.dark-theme .modal-buttons button:hover {
            background-color: #0056b3;
            box-shadow: inset 2px 2px 5px #2a2d30, inset -2px -2px 5px #42454a;
        }
        body.dark-theme .dashboard-main-card {
            background: #2c2f33;
            box-shadow: 12px 12px 35px #202225, -12px -12px 35px #383c42; /* More prominent shadow */
        }
        body.dark-theme .dashboard-main-card:hover {
            box-shadow: 15px 15px 40px #1c1e20, -15px -15px 40px #40444a; /* Even more prominent on hover */
        }


        /* Common Styles (apply to both themes) */
        .container {
            padding: 40px; /* Increased padding */
            border-radius: 20px;
            width: 95%; /* Wider on smaller screens */
            max-width: 600px; /* Max width for larger screens */
            position: relative;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 25px; /* Spacing between main sections */
            min-height: 450px; /* Ensure a minimum height for consistent look */
        }

        .header-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px; /* Spacing between buttons */
            z-index: 10; /* Ensure they are on top */
        }

        .header-actions button {
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            font-size: 0.95em;
        }

        .main-header {
            text-align: center;
            margin-bottom: 20px;
            padding-top: 30px; /* Space for buttons above */
        }

        .main-header h1 {
            margin: 0;
            font-size: 2.2em; /* Larger title */
            letter-spacing: 1px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1); /* Subtle text shadow */
        }
        .main-header p {
            font-size: 1.1em;
            opacity: 0.8;
            margin-top: 10px;
        }

        /* Section transitions */
        .form-section {
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateY(20px);
            flex-grow: 1; /* Allows sections to take available space */
        }

        .form-section.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .welcome-content {
            text-align: center;
            padding: 20px 0;
        }
        .welcome-content p {
            margin-bottom: 25px;
            font-size: 1.1em;
        }

        /* Tabs for Login/Signup */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px; /* More space below tabs */
            gap: 15px;
        }
        .tabs button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: 0.3s;
            flex: 1; /* Equal width for tabs */
            max-width: 150px; /* Limit tab width */
        }
        .tabs button.active {
            cursor: default;
        }
        .tab-content {
            display: none;
            flex-direction: column;
        }
        .tab-content.active {
            display: flex;
        }


        /* Input fields */
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 0.95em;
            text-align: left; /* Align label to left */
        }
        .input-group input {
            width: calc(100% - 30px); /* Account for padding */
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            outline: none;
            transition: box-shadow 0.3s ease;
        }
        .input-group input:focus {
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1), inset -2px -2px 5px rgba(255,255,255,0.7), 0 0 0 2px rgba(0, 123, 255, 0.5); /* Blue focus ring */
        }
        body.dark-theme .input-group input:focus {
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.3), inset -2px -2px 5px rgba(255,255,255,0.05), 0 0 0 2px rgba(0, 123, 255, 0.5);
        }

        .btn {
            margin-top: 20px; /* More spacing */
            padding: 15px; /* Larger buttons */
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            width: 100%;
            font-size: 1.1em;
        }

        .or {
            text-align: center;
            margin: 25px 0 20px; /* More vertical space */
            font-size: 0.95em;
            opacity: 0.7;
        }

        .socials {
            display: flex;
            justify-content: center; /* Center social icons */
            gap: 20px; /* Spacing between social icons */
        }

        .social {
            width: 48px; /* Slightly larger touch target */
            height: 48px;
            border-radius: 50%;
            border: none;
            font-size: 1.4em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.3s;
        }
        .social:hover {
            transform: translateY(-2px);
        }

        /* Presale Dashboard Specific Styles */
        #presale-dashboard {
            align-items: center; /* Center items in dashboard */
            text-align: center;
        }

        .wallet-info {
            margin-bottom: 25px; /* More spacing */
            font-size: 1em;
            padding: 15px; /* Larger padding */
            border-radius: 12px;
            word-break: break-all;
            line-height: 1.5;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1), inset -2px -2px 5px rgba(255,255,255,0.7);
        }
        body.dark-theme .wallet-info {
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.3), inset -2px -2px 5px rgba(255,255,255,0.05);
        }

        #presale-dashboard h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.6em;
        }

        .price-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* Adjusted min-width for better fit */
            gap: 20px; /* Increased gap */
            width: 100%; /* Ensure it takes full width */
            max-width: 500px; /* Keep it constrained on very wide screens */
            margin: 0 auto; /* Center the grid */
        }

        .price-card {
            padding: 25px; /* Increased padding */
            border-radius: 18px; /* Slightly more rounded */
            cursor: pointer;
            transition: 0.3s;
            text-align: center;
            position: relative;
            font-weight: bold;
            font-size: 1.2em; /* Larger text */
            display: flex;
            flex-direction: column;
            gap: 12px; /* Spacing inside card */
            align-items: center;
            justify-content: center; /* Vertically center content */
            min-height: 100px; /* Ensure consistent card height */
        }

        .price-card:hover {
            transform: translateY(-5px); /* More pronounced lift */
        }

        .price-card span {
            font-size: 0.9em;
            opacity: 0.8;
            font-weight: normal; /* Make XYZ amount less bold */
        }

        #transaction-status {
            margin-top: 30px; /* More spacing */
            padding: 20px; /* Larger padding */
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            display: none;
            font-size: 1.05em;
            line-height: 1.4;
            max-width: 100px; /* Constrain width */
            margin-left: auto;
            margin-right: auto;
            overflow:hidden;
        }
        #transaction-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            overflow:hidden;
        }
        #transaction-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            overflow:hidden;
        }
        body.dark-theme #transaction-status.success {
            background-color: #1e3a24;
            color: #a4e5af;
            border: 1px solid #2d4f33;
        }
        body.dark-theme #transaction-status.error {
            background-color: #4f1e24;
            color: #e5a4af;
            border: 1px solid #5f2d33;
        }

        /* User Dashboard Main Card */
        .dashboard-main-card {
            padding: 35px; /* Generous padding */
            border-radius: 25px; /* More rounded corners */
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 30px; /* Spacing between main elements within the card */
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            width: 100%; /* Take full available width */
            box-sizing: border-box;
        }
        .dashboard-main-card:hover {
            transform: translateY(-3px); /* Subtle lift on hover */
        }

        /* Dashboard Info Grid */
        .dashboard-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Adjusted min-width for better fit */
            gap: 20px; /* Spacing between info cards */
            width: 100%;
        }

        .dashboard-info-card {
            padding: 20px; /* Slightly less padding to fit more in grid */
            border-radius: 15px; /* Consistent rounding */
            text-align: center;
            font-size: 1em;
            display: flex;
            flex-direction: column;
            gap: 8px; /* Tighter spacing inside info cards */
            align-items: center;
            justify-content: center;
            min-height: 100px; /* Consistent height */
            transition: transform 0.2s ease;
        }
        .dashboard-info-card:hover {
            transform: translateY(-2px); /* Subtle lift for individual info cards */
        }

        .dashboard-info-card .label {
            font-weight: bold;
            opacity: 0.8;
            font-size: 0.85em; /* Slightly smaller label */
        }

        .dashboard-info-card .value {
            font-size: 1.3em; /* Slightly smaller value */
            font-weight: bold;
            word-break: break-all;
        }

        /* Dashboard Action Buttons */
        .dashboard-actions {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Spacing between dashboard buttons */
            width: 100%;
            margin-top: 10px; /* Space from info grid */
        }
        .dashboard-actions .btn {
            margin-top: 0; /* Override default btn margin-top */
        }

        /* reCAPTCHA specific styling */
        .g-recaptcha {
            margin: 20px auto; /* Center the recaptcha widget */
            transform-origin: 0 0; /* Set transform origin for scaling */
        }


        /* Responsive adjustments */
        @media (max-width: 480px) {
            .container {
                padding: 30px 20px; /* Smaller padding on very small screens */
            }
            .header-actions {
                flex-direction: column;
                align-items: flex-end;
                gap: 5px; /* Tighter spacing for vertical stack */
                top: 15px;
                right: 15px;
            }
            .header-actions button {
                padding: 8px 12px;
                font-size: 0.85em;
            }
            .main-header h1 {
                font-size: 1.8em;
                padding-top: 0; /* Adjust header padding since buttons are higher */
            }
            .welcome-content p {
                font-size: 1em;
            }
            .social {
                width: 40px;
                height: 40px;
                font-size: 1.1em;
            }
            .price-card {
                padding: 20px;
                font-size: 1.1em;
            }
            #presale-dashboard h2, #user-dashboard h2 {
                font-size: 1.4em;
            }
            .wallet-info {
                font-size: 0.85em;
                padding: 12px;
            }
            #transaction-status {
                font-size: 0.95em;
                padding: 15px;
            }
            .dashboard-main-card {
                padding: 25px; /* Adjust padding for smaller screens */
            }
            .dashboard-info-card {
                padding: 15px;
                font-size: 0.95em;
            }
            .dashboard-info-card .value {
                font-size: 1.1em;
            }
            .tabs {
                flex-direction: column; /* Stack tabs vertically on small screens */
                gap: 10px;
            }
            .tabs button {
                max-width: 100%; /* Full width for stacked tabs */
            }
            /* Scale reCAPTCHA for smaller screens if needed */
            .g-recaptcha {
                transform: scale(0.85); /* Adjust scale as needed for mobile */
                -webkit-transform: scale(0.85);
            }
        }

        /* Modal Overlay */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow:hidden;
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            display: flex; /* Use flexbox for centering */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            -webkit-animation: fadeIn 0.3s ease-out;
            animation: fadeIn 0.3s ease-out;
        }

        /* Modal Content/Box */
        .modal-content {
            overflow:auto;
            margin: auto; /* Auto margin for centering (fallback) */
            padding: 30px;
            border-radius: 15px; /* More rounded */
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); /* Stronger shadow */
            max-width: 500px; /* Max width of the modal */
            width: 90%; /* Responsive width */
            text-align: center;
            position: relative; /* For absolute positioning of close button */
            -webkit-animation: slideIn 0.3s ease-out;
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
            gap: 20px; /* Spacing between elements */
        }

        /* Close Button */
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
        }

        /* Message Paragraph */
        #customAlertMessage {
            font-size: 1.1em;
            margin-bottom: 0; /* No bottom margin, controlled by gap */
            line-height: 1.5;
            font-weight: 500;
            overflow:hidden;
        }

        /* Buttons Container */
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px; /* Space between buttons */
            margin-top: 10px; /* Slightly less margin, controlled by modal-content gap */
        }

        /* Confirm Button (OK) */
        .modal-buttons button {
            padding: 12px 30px; /* Larger padding */
            border: none;
            border-radius: 10px; /* More rounded buttons */
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }

        /* Animations */
        @-webkit-keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        @-webkit-keyframes slideIn {
            from {-webkit-transform: translateY(-50px); opacity: 0;}
            to {-webkit-transform: translateY(0); opacity: 1;}
        }

        @keyframes slideIn {
            from {transform: translateY(-50px); opacity: 0;}
            to {transform: translateY(0); opacity: 1;}
        }

        /* Hide modal when not active */
        .modal:not(.active) {
            display: none;
        }
    </style>
</head>
<body class="light-theme">
    <div class="container">
        <div class="header-actions">
            <button id="theme-toggle">☀️ Light</button>
            <button id="logout-btn" style="display:none;">Logout</button>
        </div>

        <div class="main-header">
            <h1>XYZ Presale</h1>
            <p id="app-subtitle">Your Gateway to the Future of Finance</p>
        </div>

        <!-- Login/Signup Section -->
        <div id="login-signup-section" class="form-section active">
            <div class="tabs">
                <button id="show-login-btn" class="active">Login</button>
                <button id="show-signup-btn">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="tab-content active">
                <div class="input-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                </div>
                <div class="input-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                <!-- reCAPTCHA for Login -->
                <div class="g-recaptcha" data-sitekey="6Lc253wrAAAAAFoY8phBUXgbPoKLRnVpAcyYCgc8" data-callback="onLoginRecaptchaSuccess"></div>
                <button id="login-btn" class="btn">Login</button>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" class="tab-content">
                <div class="input-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email">
                </div>
                <div class="input-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" placeholder="Create a password">
                </div>
                <!-- reCAPTCHA for Signup -->
                <div class="g-recaptcha" data-sitekey="6Lc253wrAAAAAFoY8phBUXgbPoKLRnVpAcyYCgc8" data-callback="onSignupRecaptchaSuccess"></div>
                <button id="signup-btn" class="btn">Sign Up</button>
            </div>

            <p class="or">Or explore our community channels</p>
            <div class="socials">
                <button class="social"><i class="fab fa-twitter"></i></button>
                <button class="social"><i class="fab fa-telegram-plane"></i></button>
                <button class="social"><i class="fab fa-discord"></i></button>
            </div>
        </div>

        <!-- User Dashboard Section -->
        <div id="user-dashboard" class="form-section">
            <h2>Welcome to Your Dashboard!</h2>
            <div class="dashboard-main-card">
                <div class="dashboard-info-grid">
                    <div class="dashboard-info-card">
                        <span class="label">User Email</span>
                        <span id="dashboard-email" class="value">N/A</span>
                    </div>
                    <div class="dashboard-info-card">
                        <span class="label">User ID</span>
                        <span id="dashboard-uid" class="value">N/A</span>
                    </div>
                    <div class="dashboard-info-card">
                        <span class="label">Connected Wallet</span>
                        <span id="dashboard-wallet-address" class="value">Not Connected</span>
                    </div>
                    <div class="dashboard-info-card">
                        <span class="label">Total XYZ Owned</span>
                        <span id="dashboard-xyz-owned" class="value">0.00</span>
                    </div>
                </div>
                <div class="dashboard-actions">
                    <button id="connect-wallet-btn" class="btn">Connect Solana Wallet</button>
                    <button id="go-to-presale-btn" class="btn">Go to Presale</button>
                </div>
            </div>
        </div>


        <!-- Presale Dashboard Section -->
        <div id="presale-dashboard" class="form-section">
            <div class="wallet-info">
                <strong>Connected Wallet:</strong> <span id="connected-wallet-address">Not Connected</span>
            </div>
            <h2>Choose Presale Amount</h2>
            <div class="price-options">
                <div class="price-card" data-sol="0.05">
                    0.05 SOL<br><span>~ <span class="xyz-amount">...</span> XYZ</span>
                </div>
                <div class="price-card" data-sol="0.08">
                    0.08 SOL<br><span>~ <span class="xyz-amount">...</span> XYZ</span>
                </div>
                <div class="price-card" data-sol="0.1">
                    0.1 SOL<br><span>~ <span class="xyz-amount">...</span> XYZ</span>
                </div>
                <div class="price-card" data-sol="0.5">
                    0.5 SOL<br><span>~ <span class="xyz-amount">...</span> XYZ</span>
                </div>
                <div class="price-card" data-sol="1">
                    1 SOL<br><span>~ <span class="xyz-amount">...</span> XYZ</span>
                </div>
            </div>
            <div id="transaction-status"></div>
            <button id="back-to-dashboard-btn" class="btn">Back to Dashboard</button>
        </div>

        <!-- Custom Alert Modal -->
        <div id="customAlertModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <p id="customAlertMessage"></p>
                <div class="modal-buttons">
                    <button id="customAlertConfirmButton">OK</button>
                </div>
            </div>
        </div>

    </div>
 <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- Solana Web3.js SDK -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <script>
        // Initialize Firebase with your provided configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDIwoUIMJrJQeLBD9vijsfIUXG9BgaGSPs",
            authDomain: "miner-zyx.firebaseapp.com",
            projectId: "miner-zyx",
            storageBucket: "miner-zyx.appspot.com",
            messagingSenderId: "430019680448",
            appId: "1:430019680448:web:d066b8aaf4355907e1b525",
            measurementId: "G-V6SDWYH6M2"
        };

        // WARNING: Using these Firebase credentials directly in client-side code
        // for write operations is INSECURE for a production application.
        // Anyone can inspect your code and gain access to write to your Firestore database.
        // For a real application, implement Firebase Security Rules and consider Cloud Functions
        // for sensitive operations like managing user data or transactions.

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Solana Configuration
        const SOLANA_RPC_URL = "https://mainnet.helius-rpc.com/?api-key=ffa4267c-d28d-4bce-baf4-6cca12c26952";
        const DESTINATION_ADDRESS = "99R4aBwwjXxeT9ukG2o1ppGE7GFEPqAWt94MvHhxoxgf";
        const connection = new solanaWeb3.Connection(SOLANA_RPC_URL, 'confirmed');

        // IMPORTANT: For accurate XYZ coin calculation, you NEED a real-time SOL to USD price.
        // This fixed rate is for demonstration purposes only. In a production app,
        // you would use a price oracle or a cryptocurrency exchange API to fetch this.
        const FIXED_SOL_TO_USD_RATE = 150; // Example: 1 SOL = 150 USD.
        const XYZ_COIN_PRICE_USD = 0.004; // Price of 1 XYZ coin in USD

        // DOM Elements
        const themeToggle = document.getElementById('theme-toggle');
        const logoutBtn = document.getElementById('logout-btn');
        const appSubtitle = document.getElementById('app-subtitle');

        // Sections
        const loginSignupSection = document.getElementById('login-signup-section');
        const userDashboardSection = document.getElementById('user-dashboard');
        const presaleDashboardSection = document.getElementById('presale-dashboard');

        // Login/Signup Elements
        const showLoginBtn = document.getElementById('show-login-btn');
        const showSignupBtn = document.getElementById('show-signup-btn');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupBtn = document.getElementById('signup-btn');

        // Dashboard Elements
        const dashboardEmailSpan = document.getElementById('dashboard-email');
        const dashboardUidSpan = document.getElementById('dashboard-uid');
        const dashboardWalletAddressSpan = document.getElementById('dashboard-wallet-address');
        const dashboardXyzOwnedSpan = document.getElementById('dashboard-xyz-owned');
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const goToPresaleBtn = document.getElementById('go-to-presale-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');

        // Presale Elements
        const connectedWalletAddressSpan = document.getElementById('connected-wallet-address');
        const priceCards = document.querySelectorAll('.price-card');
        const transactionStatusDiv = document.getElementById('transaction-status');

        let currentUser = null; // To store the authenticated Firebase user object
        let userWalletAddress = null; // To store the connected Solana wallet address for the current user

        // --- Custom Alert Modal Logic ---
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertMessageElement = document.getElementById('customAlertMessage');
        const customAlertConfirmButton = document.getElementById('customAlertConfirmButton');
        const customAlertCloseButton = customAlertModal.querySelector('.close-button');

        let currentAlertResolve = null; // To hold the promise resolve function for the current alert

/**
         * Displays a custom alert modal with a given message.
         * @param {string} message - The message to display in the alert.
         * @returns {Promise<boolean>} A promise that resolves to true when the user clicks OK.
         */
        function showCustomAlert(message) {
            return new Promise((resolve) => {
                customAlertMessageElement.textContent = message;
                customAlertModal.classList.add('active'); // Show modal
                currentAlertResolve = resolve; // Store the resolve function
            });
        }

        /**
         * Hides the custom alert modal and resolves the promise.
         */
        function hideCustomAlert() {
            customAlertModal.classList.remove('active'); // Hide modal
            if (currentAlertResolve) {
                currentAlertResolve(true); // Resolve the promise when confirmed
                currentAlertResolve = null; // Clear the resolve function
            }
        }

        // Event listeners for the custom alert modal
        customAlertConfirmButton.addEventListener('click', hideCustomAlert);
        customAlertCloseButton.addEventListener('click', hideCustomAlert);
        customAlertModal.addEventListener('click', (event) => {
            if (event.target === customAlertModal) {
                hideCustomAlert();
            }
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && customAlertModal.classList.contains('active')) {
                hideCustomAlert();
            }
        });

        // Override window.alert to use our custom modal
        window.alert = showCustomAlert;

        // --- Theme Toggle ---
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            document.body.classList.toggle('light-theme');
            if (document.body.classList.contains('dark-theme')) {
                themeToggle.innerHTML = '🌙 Dark';
                localStorage.setItem('theme', 'dark');
            } else {
                themeToggle.innerHTML = '☀️ Light';
                localStorage.setItem('theme', 'light');
            }
        });

        // Apply saved theme on load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.remove('light-theme', 'dark-theme'); // Remove existing
            document.body.classList.add(savedTheme + '-theme');
            if (savedTheme === 'dark') {
                themeToggle.innerHTML = '🌙 Dark';
            } else {
                themeToggle.innerHTML = '☀️ Light';
            }

            // Calculate XYZ for each card on load
            calculateAndDisplayXYZ();
        });

        // Function to calculate and display XYZ coin amount
        function calculateAndDisplayXYZ() {
            priceCards.forEach(card => {
                const solAmount = parseFloat(card.dataset.sol);
                const usdEquivalent = solAmount * FIXED_SOL_TO_USD_RATE;
                const xyzAmount = usdEquivalent / XYZ_COIN_PRICE_USD;
                card.querySelector('.xyz-amount').textContent = xyzAmount.toFixed(2);
            });
        }

        // --- UI Section Management ---
        /**
         * Shows a specific section and hides others.
         * @param {HTMLElement} sectionToShow - The section to make active.
         * @param {string} subtitle - The subtitle to set for the app.
         */
        function showSection(sectionToShow, subtitle = '') {
            const allSections = [loginSignupSection, userDashboardSection, presaleDashboardSection];
            allSections.forEach(section => {
                section.classList.remove('active');
            });
            sectionToShow.classList.add('active');
            appSubtitle.textContent = subtitle;
        }

        // --- Authentication Logic ---

        // Firebase Auth State Listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in.
                currentUser = user;
                console.log("User logged in:", user.email, user.uid);
                logoutBtn.style.display = 'block'; // Show logout button
                await loadUserData(user.uid); // Load user-specific data from Firestore
                showSection(userDashboardSection, 'Your Personal Dashboard');
            } else {
                // User is signed out.
                currentUser = null;
                userWalletAddress = null; // Clear wallet address on logout
                console.log("User logged out.");
                logoutBtn.style.display = 'none'; // Hide logout button
                showSection(loginSignupSection, 'Your Gateway to the Future of Finance');
                // Clear dashboard info
                dashboardEmailSpan.textContent = 'N/A';
                dashboardUidSpan.textContent = 'N/A';
                dashboardWalletAddressSpan.textContent = 'Not Connected';
                dashboardXyzOwnedSpan.textContent = '0.00';
                connectedWalletAddressSpan.textContent = 'Not Connected';
                connectWalletBtn.textContent = 'Connect Solana Wallet';
                connectWalletBtn.disabled = false;
            }
        });
 // Signup Button Click
        signupBtn.addEventListener('click', async () => {
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            // Get reCAPTCHA response for signup form (index 0 as it's the first one rendered if signup is default)
            const recaptchaResponse = grecaptcha.getResponse(signupRecaptchaId); // Use the stored ID

            if (!email || !password) {
                await showCustomAlert('Please enter both email and password for signup.');
                return;
            }
            if (!recaptchaResponse) {
                await showCustomAlert('Please complete the reCAPTCHA verification.');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                console.log('User signed up:', user.email);

                // Save user's email and UID to Firestore
                await db.collection('users').doc(user.uid).set({
                    email: user.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await showCustomAlert('Account created successfully! You are now logged in.');
                // UI will update via onAuthStateChanged listener
            } catch (error) {
                console.error('Signup error:', error);
                let errorMessage = 'Signup failed: ' + error.message;
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already in use. Please try logging in or use a different email.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Please choose a stronger password (minimum 6 characters).';
                }
                await showCustomAlert(errorMessage);
            } finally {
                // Reset reCAPTCHA for signup form
                grecaptcha.reset(signupRecaptchaId);
            }
        });

        // Login Button Click
        loginBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            // Get reCAPTCHA response for login form using its stored widget ID
            const recaptchaResponse = grecaptcha.getResponse(loginRecaptchaId);


            if (!email || !password) {
                await showCustomAlert('Please enter both email and password for login.');
                return;
            }
            if (!recaptchaResponse) {
                await showCustomAlert('Please complete the reCAPTCHA verification.');
                return;
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                console.log('User logged in:', user.email);
                await showCustomAlert('Logged in successfully!');
                // UI will update via onAuthStateChanged listener
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed: ' + error.message;
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Invalid email or password. Please try again.';
                }
                await showCustomAlert(errorMessage);
            } finally {
                // Reset reCAPTCHA for login form
                grecaptcha.reset(loginRecaptchaId);
            }
        });

        // Logout Button Click
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                await showCustomAlert('You have been logged out.');
                // UI will update via onAuthStateChanged listener
            } catch (error) {
                console.error('Logout error:', error);
                await showCustomAlert('Logout failed: ' + error.message);
            }
        });
 // Global reCAPTCHA widget IDs to manage multiple widgets
        let loginRecaptchaId;
        let signupRecaptchaId;

        // Global callback functions for reCAPTCHA (needed if data-callback is used)
        window.onLoginRecaptchaSuccess = function(token) {
            console.log("Login reCAPTCHA successful:", token);
        }

        window.onSignupRecaptchaSuccess = function(token) {
            console.log("Signup reCAPTCHA successful:", token);
        }

        // Function to render reCAPTCHA widgets explicitly
        function renderRecaptchas() {
            // Render login reCAPTCHA if its div exists and hasn't been rendered
            const loginRecaptchaDiv = document.querySelector('#login-form .g-recaptcha');
            if (loginRecaptchaDiv && loginRecaptchaId === undefined) { // Check if ID is undefined to avoid re-rendering
                loginRecaptchaId = grecaptcha.render(loginRecaptchaDiv, {
                    'sitekey': '6Lc253wrAAAAAFoY8phBUXgbPoKLRnVpAcyYCgc8', // Use your actual site key here
                    'callback': 'onLoginRecaptchaSuccess'
                });
                loginRecaptchaDiv.dataset.recaptchaId = loginRecaptchaId; // Store the widget ID
            }

            // Render signup reCAPTCHA if its div exists and hasn't been rendered
            const signupRecaptchaDiv = document.querySelector('#signup-form .g-recaptcha');
            if (signupRecaptchaDiv && signupRecaptchaId === undefined) { // Check if ID is undefined to avoid re-rendering
                signupRecaptchaId = grecaptcha.render(signupRecaptchaDiv, {
                    'sitekey': '6Lc253wrAAAAAFoY8phBUXgbPoKLRnVpAcyYCgc8', // Use your actual site key here
                    'callback': 'onSignupRecaptchaSuccess'
                });
                signupRecaptchaDiv.dataset.recaptchaId = signupRecaptchaId; // Store the widget ID
            }
        }

        // Toggle between Login and Signup forms
        showLoginBtn.addEventListener('click', () => {
            loginForm.classList.add('active');
            signupForm.classList.remove('active');
            showLoginBtn.classList.add('active');
            showSignupBtn.classList.remove('active');
            // Reset signup CAPTCHA if it was visible
            if (signupRecaptchaId !== undefined) {
                grecaptcha.reset(signupRecaptchaId);
            }
            // Ensure reCAPTCHA for login is rendered
            renderRecaptchas();
        });

        showSignupBtn.addEventListener('click', () => {
            signupForm.classList.add('active');
            loginForm.classList.remove('active');
            showSignupBtn.classList.add('active');
            showLoginBtn.classList.remove('active');
            // Reset login CAPTCHA if it was visible
            if (loginRecaptchaId !== undefined) {
                grecaptcha.reset(loginRecaptchaId);
            }
            // Ensure reCAPTCHA for signup is rendered
            renderRecaptchas();
        });

        // --- Firestore Data Management ---

        /**
         * Loads user-specific data (email, wallet address, XYZ owned) from Firestore.
         * @param {string} uid - The Firebase User ID.
         */
        async function loadUserData(uid) {
            try {
                const userDocRef = db.collection('users').doc(uid);
                const doc = await userDocRef.get();

                if (doc.exists) {
                    const userData = doc.data();
                    dashboardEmailSpan.textContent = userData.email || 'N/A';
                    dashboardUidSpan.textContent = uid;
                    userWalletAddress = userData.walletAddress || null; // Update global wallet address
                    dashboardWalletAddressSpan.textContent = userWalletAddress || 'Not Connected';
                    connectedWalletAddressSpan.textContent = userWalletAddress || 'Not Connected'; // For presale section

                    // Disable connect wallet button if already connected
                    if (userWalletAddress) {
                        connectWalletBtn.textContent = 'Wallet Connected';
                        connectWalletBtn.disabled = true;
                    } else {
                        connectWalletBtn.textContent = 'Connect Solana Wallet';
                        connectWalletBtn.disabled = false;
                    }

                    // Load total XYZ owned (example - you'd sum up past transactions)
                    const transactionsSnapshot = await db.collection('presaleTransactions')
                        .where('userId', '==', uid) // Assuming you store userId with transactions
                        .get();
                    let totalXyz = 0;
                    transactionsSnapshot.forEach(transactionDoc => {
                        totalXyz += transactionDoc.data().xyzAmount || 0;
                    });
                    dashboardXyzOwnedSpan.textContent = totalXyz.toFixed(2);

                    console.log("User data loaded from Firestore:", userData);
                } else {
                    console.log("No user document found for UID:", uid);
                    // This might happen if a user signs up but their document isn't created yet (race condition)
                    // Or if they were authenticated via an external provider without immediate Firestore doc creation.
                    dashboardEmailSpan.textContent = currentUser.email || 'N/A';
                    dashboardUidSpan.textContent = uid;
                    userWalletAddress = null;
                    dashboardWalletAddressSpan.textContent = 'Not Connected';
                    connectedWalletAddressSpan.textContent = 'Not Connected';
                    connectWalletBtn.textContent = 'Connect Solana Wallet';
                    connectWalletBtn.disabled = false;
                    dashboardXyzOwnedSpan.textContent = '0.00';
                }
            } catch (error) {
                console.error("Error loading user data from Firestore:", error);
                await showCustomAlert("Failed to load user data. Please try again.");
            }
        }

        /**
         * Saves or updates the user's Solana wallet address in Firestore.
         * @param {string} walletAddress - The Solana wallet address.
         */
        async function saveWalletAddressToFirestore(walletAddress) {
            if (!currentUser) {
                console.error("No authenticated user to save wallet address for.");
                await showCustomAlert("Please log in to save your wallet address.");
                return;
            }
            try {
                const userDocRef = db.collection('users').doc(currentUser.uid);
                await userDocRef.set({
                    walletAddress: walletAddress,
                    lastWalletConnect: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }); // Use merge: true to update existing fields without overwriting the whole document
                console.log("Wallet address saved/updated in Firestore for user:", currentUser.uid);
                userWalletAddress = walletAddress; // Update local state
                dashboardWalletAddressSpan.textContent = walletAddress;
                connectedWalletAddressSpan.textContent = walletAddress;
                connectWalletBtn.textContent = 'Wallet Connected';
                connectWalletBtn.disabled = true;
            } catch (error) {
                console.error("Error saving wallet to Firestore:", error);
                await showCustomAlert("Failed to save wallet data in Firestore. Check console for details.");
            }
        }

        /**
         * Saves transaction details to Firestore after a successful purchase.
         * @param {string} userId - The Firebase User ID.
         * @param {string} walletAddress - The Solana wallet address used.
         * @param {number} solAmount - The amount of SOL sent.
         * @param {number} xyzAmount - The calculated XYZ coin amount.
         * @param {string} transactionSignature - The Solana transaction signature.
         */
        async function saveTransactionToFirestore(userId, walletAddress, solAmount, xyzAmount, transactionSignature) {
            try {
                const transactionsRef = db.collection('presaleTransactions');
                await transactionsRef.add({
                    userId: userId,
                    walletAddress: walletAddress,
                    solAmount: solAmount,
                    xyzAmount: xyzAmount,
                    transactionSignature: transactionSignature,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed'
                });
                console.log("Transaction details saved in Firestore.");
                // Update XYZ owned on dashboard
                const currentXyz = parseFloat(dashboardXyzOwnedSpan.textContent);
                dashboardXyzOwnedSpan.textContent = (currentXyz + xyzAmount).toFixed(2);
            } catch (error) {
                console.error("Error saving transaction to Firestore:", error);
                await showCustomAlert("Failed to save transaction data in Firestore. Check console for details.");
            }
        }

        // --- Solana Wallet Integration ---

        // Connect Wallet Function (Solana Wallet Integration)
        connectWalletBtn.addEventListener('click', async () => {
            if (!currentUser) {
                await showCustomAlert('Please log in first to connect your Solana wallet.');
                return;
            }
            if (userWalletAddress) {
                await showCustomAlert('Wallet already connected: ' + userWalletAddress);
                return;
            }

            transactionStatusDiv.style.display = 'none'; // Hide previous status

            try {
                // Check if a Solana wallet (e.g., Phantom) is available
                if (window.solana && window.solana.isPhantom) {
                    // Request wallet connection. This will prompt the user in their wallet extension.
                    const resp = await window.solana.connect();
                    const newWalletAddress = resp.publicKey.toString();

                    await saveWalletAddressToFirestore(newWalletAddress); // Save to Firestore
                    await showCustomAlert('Wallet connected successfully! Address: ' + newWalletAddress);

                } else {
                    await showCustomAlert('Solana wallet (e.g., Phantom) not found. Please install a Solana wallet browser extension to proceed.');
                    // Optionally provide a link to a popular wallet
                    window.open('https://phantom.app/', '_blank');
                }
            } catch (err) {
                console.error("Wallet connection failed:", err);
                await showCustomAlert("Wallet connection failed. Please ensure your wallet is unlocked and try again. Error: " + err.message);
            }
        });
 // --- Presale Purchase Logic ---

        // Handle Presale Purchase Clicks
        priceCards.forEach(card => {
            card.addEventListener('click', async () => {
                if (!currentUser) {
                    await showCustomAlert('Please log in to buy XYZ coins.');
                    return;
                }
                if (!userWalletAddress) {
                    await showCustomAlert('Please connect your Solana wallet first to buy XYZ coins.');
                    return;
                }

                transactionStatusDiv.style.display = 'none'; // Hide previous status

                const solAmount = parseFloat(card.dataset.sol);
                const xyzCalculatedAmount = parseFloat(card.querySelector('.xyz-amount').textContent);

                // Step 1: Confirm with the user using custom modal
                const confirmation = await showCustomAlert(
                    `You are about to buy ${solAmount} SOL worth of XYZ Coin.\n` +
                    `This will get you approximately ${xyzCalculatedAmount.toFixed(2)} XYZ coins.\n\n` +
                    `Confirm to proceed with the transaction in your wallet.`
                );

                // Our custom alert only has an OK button, so this will always be true if they click OK.
                // If we wanted a confirm, we'd need two buttons and resolve true/false.
                console.log('Transaction initiated by user.');


                // Step 2: Initiate Solana Transaction
                try {
                    const fromWalletPublicKey = new solanaWeb3.PublicKey(userWalletAddress);
                    const toWalletPublicKey = new solanaWeb3.PublicKey(DESTINATION_ADDRESS);

                    // Convert SOL to lamports (1 SOL = 1,000,000,000 lamports)
                    const lamports = solanaWeb3.LAMPORTS_PER_SOL * solAmount;

                    let transaction = new solanaWeb3.Transaction().add(
                        solanaWeb3.SystemProgram.transfer({
                            fromPubkey: fromWalletPublicKey,
                            toPubkey: toWalletPublicKey,
                            lamports: lamports,
                        })
                    );

                    // Get the latest blockhash for the transaction
                    const { blockhash } = await connection.getLatestBlockhash();
                    transaction.recentBlockhash = blockhash;
                    transaction.feePayer = fromWalletPublicKey;

                    // Prompt the user to sign and send the transaction via their wallet extension
                    const signedTransaction = await window.solana.signAndSendTransaction(transaction);

                    // Wait for transaction confirmation
                    const { value: status } = await connection.confirmTransaction({
                        signature: signedTransaction.signature,
                        blockhash: blockhash,
                        lastValidBlockHeight: (await connection.getLatestBlockhash()).lastValidBlockHeight
                    }, 'confirmed'); // Specify 'confirmed' for the commitment level

                    if (status.err) {
                        throw new Error('Transaction failed on blockchain: ' + JSON.stringify(status.err));
                    }

                    console.log('Transaction successful! Signature:', signedTransaction.signature);
                    displayTransactionStatus('Transaction successful! You bought ' + xyzCalculatedAmount.toFixed(2) + ' XYZ coins.', 'success');
                    await showCustomAlert('Transaction successful! You bought ' + xyzCalculatedAmount.toFixed(2) + ' XYZ coins.');


                    // Step 3: Save Transaction Details to Firestore
                    await saveTransactionToFirestore(currentUser.uid, userWalletAddress, solAmount, xyzCalculatedAmount, signedTransaction.signature);

                } catch (error) {
                    console.error("Solana transaction failed:", error);
                    let errorMessage = "Solana transaction failed. ";
                    if (error.message.includes('User rejected the request')) {
                        errorMessage += "Transaction rejected by user in wallet.";
                    } else if (error.message.includes('Insufficient funds')) {
                        errorMessage += "Insufficient SOL balance in your wallet.";
                    } else {
                        errorMessage += error.message; // Show detailed error if not a common one
                    }
                    displayTransactionStatus(errorMessage, 'error');
                    await showCustomAlert(errorMessage);
                }
            });
        });

        // Function to display transaction status messages (below price cards)
        function displayTransactionStatus(message, type) {
            transactionStatusDiv.textContent = message;
            transactionStatusDiv.className = ''; // Clear previous classes
            transactionStatusDiv.classList.add(type);
            transactionStatusDiv.style.display = 'block';
            transactionStatusDiv.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Scroll to message
        }

        // --- Navigation Buttons ---
        goToPresaleBtn.addEventListener('click', () => {
            if (!currentUser) {
                showCustomAlert("Please log in to access the presale.");
                return;
            }
            showSection(presaleDashboardSection, 'Participate in Presale');
        });

        backToDashboardBtn.addEventListener('click', () => {
            if (!currentUser) {
                showCustomAlert("Please log in to access the dashboard.");
                return;
            }
            showSection(userDashboardSection, 'Your Personal Dashboard');
        });

        // Initial reCAPTCHA rendering for the active tab on page load
        // This ensures the CAPTCHA is visible immediately on the default login tab.
        // The grecaptcha.ready function ensures the reCAPTCHA API is fully loaded before rendering.
        grecaptcha.ready(function() {
            // Render login reCAPTCHA initially (assuming login form is active by default)
            const loginRecaptchaDiv = document.querySelector('#login-form .g-recaptcha');
            if (loginRecaptchaDiv) {
                loginRecaptchaId = grecaptcha.render(loginRecaptchaDiv, {
                    'sitekey': '6Lc253wrAAAAAFoY8phBUXgbPoKLRnVpAcyYCgc8', // Use your actual site key here
                    'callback': 'onLoginRecaptchaSuccess'
                });
                loginRecaptchaDiv.dataset.recaptchaId = loginRecaptchaId; // Store the widget ID
            }

            // Render signup reCAPTCHA (it will be hidden initially)
            const signupRecaptchaDiv = document.querySelector('#signup-form .g-recaptcha');
            if (signupRecaptchaDiv) {
                signupRecaptchaId = grecaptcha.render(signupRecaptchaDiv, {
                    'sitekey': '6Lc253wrAAAAAFoY8phBUXgbPoKLRnVpAcyYCgc8', // Use your actual site key here
                    'callback': 'onSignupRecaptchaSuccess'
                });
                signupRecaptchaDiv.dataset.recaptchaId = signupRecaptchaId; // Store the widget ID
            }
        });
    </script>
</body>
</html>